<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pdf2png</title>
    <style>
      .flex {
        display: flex;
      }
      .flex-1 {
        flex: 1;
      }
      .float-right {
        float: right;
      }
      body {
        margin: 0;
        font-size: 14px;
        overflow: hidden;
      }
      .box {
        height: 100vh;
        overflow: auto;
      }

      .container {
        position: relative;
        height: 100vh;
      }

      footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        border-top: 1px solid #ddd;
        padding: 15px 0;
        z-index: 100;
        box-sizing: border-box;
        background-color: #f5f5f5;
      }

      .btn {
        display: inline-block;
        height: 32px;
        line-height: 32px;
        padding: 0 12px;
        margin-right: 8px;
        border: 1px solid #ddd;
        cursor: pointer;
        border-radius: 4px;
      }

      .btn-primary {
        background-color: #38f;
        color: #fff;
      }

      .btn-info {
        background-color: rgb(255, 109, 51);
        color: #fff;
      }

      .input {
        height: 32px;
        outline: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 0 8px;
        padding-left: 5px;
        width: 180px;
      }

      .info {
        position: absolute;
        top: 5px;
        left: 10px;
      }

      canvas {
        position: relative;
        display: block;
        margin: 0 auto;
        outline: 1px solid #ddd;
      }
    </style>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.9.359/build/pdf.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/x-template" id="template">
      <div class="box">

        <div class="container" id="container" ref="container"></div>
        <footer>
            <label class="btn btn-primary">
              <input @change="fileChange" type="file" style="display:none">
              选择一个pdf文件
            </label>
            <button class="btn btn-info" type="button" @click="exportImages">下载</button>
            <input class="input" v-model.trim="exportName" placeholder="请输入导出图片名称" maxlength="50" >
            <div class="info">
              <div><b>页数</b>：{{pages}}</div>
              <div><b>文件名</b>：{{fileName}}</div>
              <div><b>文件大小</b>：{{fileSize}}</div>
            </div>
        </footer>
      </div>
    </script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.9.359/build/pdf.worker.js";

      var instance = new Vue({
        el: "#app",
        template: "#template",
        data() {
          return {
            loading: false,
            exportName: "",
            pages: "",
            fileName: "",
            fileSize: "",
            pdf: null,
          };
        },
        mounted() {},
        methods: {
          fileChange(e) {
            const vm = this;
            const file = e.target.files[0];
            if (!file) {
              return;
            }
            this.$refs.container.innerHTML = "";
            const size = file.size;
            const mb = (size / 1048576).toFixed(2) + "Mb";
            this.fileSize = mb;
            this.fileName = file.name;
            this.readPdf(file);
            e.target.value = "";
          },
          readPdf(file) {
            const vm = this;
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = function (e) {
              const typedarray = new Uint8Array(this.result);
              const loadingTask = pdfjsLib.getDocument(typedarray);
              loadingTask.promise
                .then(function (pdf) {
                  if (pdf) {
                    vm.pdf = pdf;
                    vm.pages = pdf.numPages;
                    vm.renderPdf(pdf);
                  }
                })
                .catch(function (reason) {
                  console.error("Error: " + reason);
                });
            };
          },
          renderPdf(pdf) {
            const vm = this;
            for (let i = 1; i <= pdf.numPages; i++) {
              pdf.getPage(i).then(function (page) {
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                vm.$refs.container.appendChild(canvas);
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.dataset.id = i;
                page.render({
                  canvasContext: context,
                  viewport: viewport,
                });
              });
            }
          },
          exportImages() {
            const oCanvass = document.getElementsByTagName("canvas");
            downloadQueue(Array.from(oCanvass), this.exportName);
          },
        },
      });

      function downloadQueue(list, name) {
        function getData(list) {
          var queue = [];
          list.forEach(function (canvas, index) {
            queue.push(function () {
              const base64 = canvas.toDataURL("image/png");
              var a = document.createElement("a");
              a.download = `${name}${index + 1}.png`;
              a.href = base64;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setTimeout(() => {
                next();
              }, 100);
            });
          });
          function next() {
            if (!queue.length) {
              return;
            }
            queue.shift()();
          }
          return next;
        }
        var next = getData(list);
        next();
      }
    </script>
  </body>
</html>
