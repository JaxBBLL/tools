<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <title>pdf2image</title>
    <style>
      html {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI,
          Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif,
          Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
        box-sizing: border-box;
      }
      *,
      *::before,
      *::after {
        box-sizing: inherit;
      }
      .flex {
        display: flex;
      }
      .inline-flex {
        display: inline-flex;
      }
      .flex-1 {
        flex: 1;
      }
      .items-center {
        align-items: center;
      }
      .text-orange {
        color: rgb(248, 140, 39);
      }
      .text-12 {
        font-size: 12px;
      }
      body {
        margin: 0;
        font-size: 14px;
        overflow: hidden;
      }
      .app {
        height: 100vh;
        overflow: auto;
      }
      .container {
        position: relative;
        height: 100vh;
      }
      .footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px 0;
        z-index: 100;
        box-sizing: border-box;
        background-color: #fff;
        box-shadow: 0px 0px 13px 0px #d0d0d0;
      }
      .btn {
        display: inline-block;
        height: 32px;
        line-height: 32px;
        padding: 0 12px;
        margin-right: 8px;
        border: 1px solid #ddd;
        cursor: pointer;
        border-radius: 4px;
      }
      .btn:hover {
        opacity: 0.8;
      }
      .btn-primary {
        background-color: #38f;
        color: #fff;
      }
      .btn-info {
        background-color: rgb(255, 109, 51);
        color: #fff;
      }
      .input {
        height: 32px;
        outline: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 8px;
        margin-left: 8px;
        width: 140px;
        padding-left: 5px;
      }
      .input:focus {
        border-color: #cbe5f7;
      }
      .info {
        position: absolute;
        top: 5px;
        left: 10px;
        font-size: 12px;
        line-height: 1.5;
      }
      .set-wrap {
        position: absolute;
        display: flex;
        align-items: center;
        top: 8px;
        right: 10px;
        font-size: 12px;
        line-height: 1.5;
      }
      canvas {
        position: relative;
        display: block;
        margin: 0 auto;
        outline: 1px solid #ddd;
      }
    </style>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.9.359/build/pdf.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/x-template" id="template">
      <div class="app">
        <div class="container" id="container" ref="container"></div>
        <footer class="footer">
            <label class="btn btn-primary">
              <input @change="fileChange" accept="application/pdf" type="file" style="display:none">
              选择一个pdf文件
            </label>
            <button class="btn btn-info" type="button" @click="exportImages">导出图片</button>
            <div class="set-wrap">
              <input class="input" v-model.trim="exportName" placeholder="请输入导出图片名称" maxlength="50" >
              <div>
                <div class="flex items-center" style="margin-bottom: 5px">
                  <span>导出图片格式：</span>
                  <label class="inline-flex items-center"><input v-model="suffix" type="radio" value="png">png</label>
                  <label class="inline-flex items-center"><input v-model="suffix" type="radio" value="jpg">jpg</label>
                  <label class="inline-flex items-center"><input v-model="suffix" type="radio" value="webp">webp</label>
                </div>
                <div class="flex">
                  <div><span>缩放比例</span> <span class="text-orange">{{scale}}</span></div>
                  <input @change="selectChange" type="range" max="2" min="0.5" v-model="scale" step="0.1">
                </div>
              </div>
            </div>
            <div class="info">
              <div>页数：<b>{{pages}}</b></div>
              <div>文件名：<b>{{fileName}}</b></div>
              <div>文件大小：<b>{{fileSize}}</b></div>
            </div>
        </footer>
      </div>
    </script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.9.359/build/pdf.worker.js";

      new Vue({
        el: "#app",
        template: "#template",
        data() {
          return {
            exportName: "",
            pages: "",
            fileName: "",
            fileSize: "",
            suffix: "png",
            pdf: null,
            scale: 1,
          };
        },
        mounted() {},
        methods: {
          fileChange(e) {
            const vm = this;
            const file = e.target.files[0];
            if (!file) {
              return;
            }
            const size = file.size;
            const mb = (size / 1048576).toFixed(2) + "Mb";
            this.fileSize = mb;
            this.fileName = file.name;
            this.readPdf(file);
            e.target.value = "";
          },
          readPdf(file) {
            const vm = this;
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = function (e) {
              const typedarray = new Uint8Array(this.result);
              const loadingTask = pdfjsLib.getDocument(typedarray);
              loadingTask.promise
                .then(function (pdf) {
                  if (pdf) {
                    vm.pdf = pdf;
                    vm.pages = pdf.numPages;
                    vm.renderPdf(pdf);
                  }
                })
                .catch(function (reason) {
                  console.error("Error: " + reason);
                });
            };
          },
          renderPdf(pdf) {
            this.$refs.container.innerHTML = "";
            const vm = this;
            for (let i = 1; i <= pdf.numPages; i++) {
              pdf.getPage(i).then(function (page) {
                const viewport = page.getViewport({ scale: vm.scale });
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                vm.$refs.container.appendChild(canvas);
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.dataset.id = i;
                page.render({
                  canvasContext: context,
                  viewport: viewport,
                });
              });
            }
          },
          selectChange(e) {
            const value = e.target.value;
            if (this.pdf) {
              this.renderPdf(this.pdf);
            }
          },
          exportImages() {
            const oCanvass = document.getElementsByTagName("canvas");
            if (!oCanvass.length) {
              alert("请先导入PDF文件");
              return;
            }
            downloadQueue(Array.from(oCanvass), this.exportName, this.suffix);
          },
        },
      });

      function downloadQueue(list, name, suffix) {
        const suffixMap = {
          jpg: "image/jpeg",
          png: "image/png",
          webp: "image/webp",
        };
        function getData(list) {
          var queue = [];
          list.forEach(function (canvas, index) {
            queue.push(function () {
              const base64 = canvas.toDataURL(suffixMap[suffix]);
              const a = document.createElement("a");
              a.download = `${name}${index + 1}.${suffix}`;
              a.href = base64;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setTimeout(() => {
                next();
              }, 100);
            });
          });
          function next() {
            if (!queue.length) {
              return;
            }
            queue.shift()();
          }
          return next;
        }
        var next = getData(list);
        next();
      }
    </script>
  </body>
</html>
